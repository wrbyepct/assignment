#!/bin/bash

set -e

# ==================== é¡è‰²è¼¸å‡º ====================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "\n${BLUE}========== $1 ==========${NC}\n"; }



# ========== ETL commands ===========
dry-run() {
    docker compose exec django python -m core.manage load_tax_registration --limit 10000 --dry-run

}

etl() {
    docker compose exec django python -m core.manage load_tax_registration --truncate

}

resume() {
    docker compose django python -m core.manage load_tax_registration --resume
}

# ========== Django cocmmands ===========

server() {
    # For local run
    poetry run python -m core.manage runserver
}

create-admin() {
    # For local run
    poetry run python -m core.manage createsuperuser --noinput || echo "è¶…ç´šç®¡ç†å“¡å¯èƒ½å·²å­˜åœ¨ï¼Œè·³éŽå»ºç«‹ã€‚"
}

migrations() {
    # Run in docker
    docker compose exec django python -m core.manage makemigrations $@
}

migrate() {
    # Run in docker
    docker compose exec django python -m core.manage migrate
}


# ========== Docker cocmmands ===========

up() {
    
    docker compose -f docker-compose.yml up $@ --build -d 
}

down() {
    docker compose -f docker-compose.yml down
}

container-shell() {
    docker compose exec django bash
}

django-shell() {
    docker compose exec django python -m core.manage shell
}

# ==================== Terraform æŒ‡ä»¤ ====================
tf-init() {
    docker compose -f terraform/tf.yml run --rm terraform init
}

tf-validate() {
    docker compose -f terraform/tf.yml run --rm terraform validate

}

tf-format() {
    docker compose -f terraform/tf.yml run --rm terraform fmt 

}

tf-plan() {
    docker compose -f terraform/tf.yml run --rm terraform plan
}

tf-apply() {
    docker compose -f terraform/tf.yml run --rm terraform apply -auto-approve

}

tf-destroy() {
    read -p "ç¢ºå®šè¦ç¹¼çºŒå—Žï¼Ÿ(yes/no): " confirm
    if [ "$confirm" = "yes" ]; then
        docker compose -f terraform/tf.yml run --rm terraform destroy -auto-approve
    else
        echo "[INFO] æ“ä½œå·²å–æ¶ˆ"
    fi
}



# ========== QA cocmmands ===========
lint() {
    git add .; poetry run pre-commit run --all-files 
}



# ==================== Terraform åˆå§‹åŒ–èˆ‡éƒ¨ç½² ====================
run_terraform() {
    log_step "Step 1: Terraform åˆå§‹åŒ–èˆ‡éƒ¨ç½²"
    
    # Init
    log_info "åŸ·è¡Œ terraform init..."
    tf-init
    # Apply
    log_info "åŸ·è¡Œ terraform apply..."
    tf-apply    
    log_info "âœ… Terraform éƒ¨ç½²å®Œæˆ"
}

# ==================== å–å¾— Terraform Output ====================
get_terraform_outputs() {
    log_step "Step 2: å–å¾— IAM User Credentials"
    
    # å–å¾— outputs
    AWS_ACCESS_KEY_ID=$(docker compose -f terraform/tf.yml run --rm terraform output -raw aws_access_key_id)
    AWS_SECRET_ACCESS_KEY=$(docker compose -f terraform/tf.yml run --rm terraform output -raw aws_secret_access_key)
    LOG_GROUP_NAME=$(docker compose -f terraform/tf.yml run --rm terraform output -raw log_group_name)
    AWS_REGION=$(docker compose -f terraform/tf.yml run --rm terraform output -raw aws_region 2>/dev/null || echo "ap-northeast-1")
    
    if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
        log_error "ç„¡æ³•å–å¾— IAM credentialsï¼"
        exit 1
    fi
    
    log_info "âœ… å·²å–å¾— log-writer IAM user credentials"
}

# ==================== å¯«å…¥ .env.local ====================
write_env_local() {
    log_step "Step 3: å¯«å…¥ .env.local"
    
    # å¾ž .env.example è¤‡è£½ï¼ˆå¦‚æžœ .env.local ä¸å­˜åœ¨ï¼‰
    if [ ! -f ".env.local" ]; then
        cp .env.example .env.local
        log_info "å·²å¾ž .env.example å»ºç«‹ .env.local"
    fi
    
    # æ›´æ–°æˆ–æ–°å¢ž AWS ç›¸é—œè®Šæ•¸
    update_env_var ".env.local" "AWS_ACCESS_KEY_ID" "$AWS_ACCESS_KEY_ID"
    update_env_var ".env.local" "AWS_SECRET_ACCESS_KEY" "$AWS_SECRET_ACCESS_KEY"
    update_env_var ".env.local" "AWS_REGION" "$AWS_REGION"
    update_env_var ".env.local" "CLOUDWATCH_LOG_GROUP" "$LOG_GROUP_NAME"
    
    log_info "âœ… .env.local å·²æ›´æ–°"
}

# ==================== å¯«å…¥ CloudWatch Agent credentials ====================
write_cloudwatch_agent_credentials() {
    log_step "Step 4: å¯«å…¥ CloudWatch Agent credentials"
    
    # ç¢ºä¿ç›®éŒ„å­˜åœ¨
    mkdir -p docker/cloudwatch-agent/.aws
    
    # å¯«å…¥ credentials æª”æ¡ˆ
    cat > docker/cloudwatch-agent/.aws/credentials << EOF
[AmazonCloudWatchAgent]
aws_access_key_id = ${AWS_ACCESS_KEY_ID}
aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
EOF
    
    
    # è¨­å®šæ¬Šé™ï¼ˆåªæœ‰æ“æœ‰è€…å¯è®€ï¼‰
    chmod 600 docker/cloudwatch-agent/.aws/credentials
    
    log_info "âœ… CloudWatch Agent credentials å·²å¯«å…¥"
}

# ==================== å•Ÿå‹• Docker Compose ====================
start_docker_compose() {
    log_step "Step 5: å•Ÿå‹• Docker Compose"
    
    # Build and start    
    log_info "Starting containers..."
    ./run up
    
}


show_completion_message() {
    log_step "ðŸŽ‰ è¨­å®šå®Œæˆï¼"
    
    echo -e "${GREEN}"
    echo "=============================================="
    echo "  ç’°å¢ƒå·²æˆåŠŸè¨­å®šï¼"
    echo "=============================================="
    echo -e "${NC}"
    echo ""
    echo "ðŸ“ æœå‹™ä½ç½®ï¼š"
    echo "   - Django Admin: http://localhost:8000/admin"
    echo "   - CloudWatch Dashboard: è«‹è‡³ AWS Console æŸ¥çœ‹"
    echo ""
    echo "ðŸ“‹ å¾ŒçºŒæŒ‡ä»¤ï¼š"
    echo "   ./run dry-run        # æ¸¬è©¦ ETLï¼ˆä¸å¯¦éš›å¯«å…¥ï¼‰"
    echo "   ./run etl            # åŸ·è¡Œå®Œæ•´ ETL"
    echo "   ./run resume         # åŸ·è¡Œä»»å‹™æ–·é»žçºŒå‚³"
    echo "   ./run verify-logs    # ç¢ºèª CloudWatch æ”¶åˆ° log"
    echo ""
   
}

cleanup() {
    log_step "æ¸…ç† AWS è³‡æº"
    
    log_warn "å³å°‡éŠ·æ¯€æ‰€æœ‰ AWS è³‡æºï¼"
    read -p "ç¢ºå®šè¦ç¹¼çºŒå—Žï¼Ÿ(yes/no): " confirm
    
    if [ "$confirm" = "yes" ]; then
        docker compose down
        docker compose -f terraform/tf.yml run --rm terraform destroy -auto-approve
        log_info "âœ… æ¸…ç†å®Œæˆ"
    else
        log_info "æ“ä½œå·²å–æ¶ˆ"
    fi
}


setup() {
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘                                                            â•‘${NC}"
    echo -e "${BLUE}â•‘   ðŸš€ ETL Log Collection System - One Click Setup          â•‘${NC}"
    echo -e "${BLUE}â•‘                                                            â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    run_terraform
    get_terraform_outputs
    write_env_local
    write_cloudwatch_agent_credentials
    start_docker_compose
    show_completion_message
}



help() {
    echo "${1} <task> <arg>s"
    echo "Tasks:"
    compgen -A function | cat -n 
}

TIMEFORMAT="Task completed in %3lR"
time ${@:-help}
