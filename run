#!/bin/bash




# ========== ETL commands ===========
dry-run() {
    docker compose exec django python -m core.manage load_tax_registration --limit 10000 --dry-run

}

update-import() {
    docker compose exec django python -m core.manage load_tax_registration --truncate

}

resume() {
    docker compose django python -m core.manage load_tax_registration --resume
}

# ========== Django cocmmands ===========

server() {
    # For local run
    poetry run python -m core.manage runserver
}

create-admin() {
    # For local run
    poetry run python -m core.manage createsuperuser --noinput || echo "è¶…ç´šç®¡ç†å“¡å¯èƒ½å·²å­˜åœ¨ï¼Œè·³éŽå»ºç«‹ã€‚"
}

migrations() {
    # Run in docker
    docker compose exec django python -m core.manage makemigrations $@
}

migrate() {
    # Run in docker
    docker compose exec django python -m core.manage migrate
}


# ========== Docker cocmmands ===========

up() {
    
    docker compose -f docker-compose.yml up $@ --build -d 
}

down() {
    docker compose -f docker-compose.yml down
}

app-shell() {
    docker compose exec django bash
}

shell() {
    poetry run python -m core.manage shell
}

# ==================== Terraform æŒ‡ä»¤ ====================
tf-init() {
    echo "[STEP] åˆå§‹åŒ– Terraform..."
    docker compose -f terraform/tf.yml run --rm terraform init
}

tf-validate() {
    docker compose -f terraform/tf.yml run --rm terraform validate

}

tf-format() {
    docker compose -f terraform/tf.yml run --rm terraform fmt 

}

tf-plan() {
    echo "[STEP] åŸ·è¡Œ Terraform plan..."
    docker compose -f terraform/tf.yml run --rm terraform plan
}

tf-apply() {
    echo "[STEP] åŸ·è¡Œ Terraform apply..."
    docker compose -f terraform/tf.yml run --rm terraform apply -auto-approve

}

tf-destroy() {
    echo "[WARN] å³å°‡éŠ·æ¯€æ‰€æœ‰ AWS è³‡æºï¼"
    read -p "ç¢ºå®šè¦ç¹¼çºŒå—Žï¼Ÿ(yes/no): " confirm
    if [ "$confirm" = "yes" ]; then
        cd terraform && terraform destroy -auto-approve
    else
        echo "[INFO] æ“ä½œå·²å–æ¶ˆ"
    fi
}

# ==================== CloudWatch é©—è­‰æŒ‡ä»¤ ====================
verify-logs() {
    echo "[STEP] é©—è­‰ CloudWatch Logs..."
    
    # è¼‰å…¥ç’°å¢ƒè®Šæ•¸
    source .env.local 2>/dev/null
    
    LOG_GROUP="${CLOUDWATCH_LOG_GROUP:-/docker/etl}"
    
    # åˆ—å‡ºæœ€è¿‘çš„ log äº‹ä»¶
    docker compose exec django aws logs filter-log-events \
        --log-group-name "$LOG_GROUP" \
        --limit 10 \
        --region "$AWS_REGION"
}



# ==================== AWS setup  ====================

setup-aws-secrets() {
    # è¼‰å…¥è®Šæ•¸
    source .env.local
    
    # å¯«å…¥ credentials çµ¦ Docker daemon è®€
    if [ ! -f ~/.aws/credentials ]; then
        mkdir -p ~/.aws

    fi
    cat > ~/.aws/credentials << EOF
[default]
aws_access_key_id = ${AWS_ACCESS_KEY_ID}
aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
EOF

    chmod 600 ~/.aws/credentials
    echo "[INFO] âœ… ~/.aws/credentials å·²å»ºç«‹"
}

setup-cloudwatch() {
    echo "=========================================="
    echo "ðŸš€ é–‹å§‹ä¸€éµè¨­å®š..."
    echo "=========================================="
    

    echo ""
    echo "[Step 1/2] åˆå§‹åŒ– Terraform..."
    tf-init
    
    echo ""
    echo "[Step 2/2] å»ºç«‹ AWS è³‡æº..."
    tf-apply
    
}


# ========== QA cocmmands ===========
lint() {
    git add .; poetry run pre-commit run --all-files 
}


help() {
    echo "${1} <task> <arg>s"
    echo "Tasks:"
    compgen -A function | cat -n 
}

TIMEFORMAT="Task completed in %3lR"
time ${@:-help}
