#!/bin/bash




# ========== ETL commands ===========
dry-run() {
    docker compose exec django python -m core.manage load_tax_registration --limit 10000 --dry-run

}

update-import() {
    python -m core.manage load_tax_registration --truncate

}

resume() {
    python -m core.manage load_tax_registration --resume
}

# ========== Django cocmmands ===========

server() {
    python -m core.manage runserver
}

create-admin() {

    python -m core.manage createsuperuser --noinput || echo "è¶…ç´šç®¡ç†å“¡å¯èƒ½å·²å­˜åœ¨ï¼Œè·³éå»ºç«‹ã€‚"
}

migrations() {
    python -m core.manage makemigrations $@
}

migrate() {
    python -m core.manage migrate
}


# ========== Docker cocmmands ===========

up() {
    docker-compose -f docker-compose.yml up $@ --build -d 
}

down() {
    docker-compose -f docker-compose.yml down
}

app-shell() {
    docker compose exec django bash
}

shell() {
    poetry run python -m core.manage shell
}

# ==================== Terraform æŒ‡ä»¤ ====================
tf-init() {
    echo "[STEP] åˆå§‹åŒ– Terraform..."
    docker compose -f terraform/tf.yml run --rm terraform init
}

tf-validate() {
    docker compose -f terraform/tf.yml run --rm terraform validate

}

tf-format() {
    docker compose -f terraform/tf.yml run --rm terraform fmt 

}

tf-plan() {
    echo "[STEP] åŸ·è¡Œ Terraform plan..."
    docker compose -f terraform/tf.yml run --rm terraform plan
}

tf-apply() {
    echo "[STEP] åŸ·è¡Œ Terraform apply..."
    docker compose -f terraform/tf.yml run --rm terraform apply -auto-approve

}

tf-destroy() {
    echo "[WARN] å³å°‡éŠ·æ¯€æ‰€æœ‰ AWS è³‡æºï¼"
    read -p "ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ(yes/no): " confirm
    if [ "$confirm" = "yes" ]; then
        cd terraform && terraform destroy -auto-approve
    else
        echo "[INFO] æ“ä½œå·²å–æ¶ˆ"
    fi
}

# ==================== CloudWatch é©—è­‰æŒ‡ä»¤ ====================
# ç‚ºä»€éº¼éœ€è¦ï¼šè®“å¯©é–±äººå“¡å¯ä»¥å¿«é€Ÿç¢ºèª log æœ‰é€åˆ° CloudWatch
verify-logs() {
    echo "[STEP] é©—è­‰ CloudWatch Logs..."
    
    # è¼‰å…¥ç’°å¢ƒè®Šæ•¸
    source .env.local 2>/dev/null
    
    LOG_GROUP="${CLOUDWATCH_LOG_GROUP:-/docker/etl}"
    
    # åˆ—å‡ºæœ€è¿‘çš„ log äº‹ä»¶
    aws logs filter-log-events \
        --log-group-name "$LOG_GROUP" \
        --limit 10 \
        --region "$AWS_REGION"
}

# ==================== One click AWS credentials setup  ====================
setup() {
    echo "=========================================="
    echo "ğŸš€ é–‹å§‹ä¸€éµè¨­å®š..."
    echo "=========================================="
    
    # æª¢æŸ¥ .env.local æ˜¯å¦å­˜åœ¨
    if [ ! -f ".env.local" ]; then
        echo "[ERROR] .env.local ä¸å­˜åœ¨ï¼"
        echo "è«‹å…ˆåŸ·è¡Œ: cp .env.example .env.local"
        echo "ç„¶å¾Œå¡«å…¥ä½ çš„ AWS credentials" # Log writer IAM user
        exit 1
    fi
    
    # è¼‰å…¥ç’°å¢ƒè®Šæ•¸
    source .env.local
    
    # æª¢æŸ¥ AWS credentials æ˜¯å¦å·²å¡«å…¥
    if [ "$AWS_ACCESS_KEY_ID" = "your-access-key-id" ]; then
        echo "[ERROR] è«‹å…ˆåœ¨ .env.local å¡«å…¥çœŸå¯¦çš„ AWS credentialsï¼"
        exit 1
    fi
    
    echo ""
    echo "[Step 1/4] åˆå§‹åŒ– Terraform..."
    tf-init
    
    echo ""
    echo "[Step 2/4] å»ºç«‹ AWS è³‡æº..."
    tf-apply
    
    echo ""
    echo "[Step 3/4] å•Ÿå‹• Docker å®¹å™¨..."
    up
    
    echo ""
    echo "[Step 4/4] ç­‰å¾…æœå‹™å°±ç·’..."
    sleep 10
    
    echo ""
    echo "=========================================="
    echo "âœ… è¨­å®šå®Œæˆï¼"
    echo "=========================================="
    echo ""
    echo "å¾ŒçºŒæŒ‡ä»¤ï¼š"
    echo "  ./run dry-run       # æ¸¬è©¦ ETL"
    echo "  ./run verify-logs   # ç¢ºèª CloudWatch æ”¶åˆ° log"
}


# ========== QA cocmmands ===========
lint() {
    git add .; poetry run pre-commit run --all-files 
}


help() {
    echo "${1} <task> <arg>s"
    echo "Tasks:"
    compgen -A function | cat -n 
}

TIMEFORMAT="Task completed in %3lR"
time ${@:-help}
